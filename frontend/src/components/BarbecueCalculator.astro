---
import styles from "../styles/calculator.module.css";
import { DURATION_RULES, MEATS, DEFAULTS } from "../config/bbqConfig.js";

type Meat = { id: string; label: string; defaultWeight: number; group?: string };
const meats = MEATS as unknown as Meat[];

const titleText = "Calculadora de Churrasco";
const titleChars = [...titleText];
const lettersOnly = titleChars.filter((c) => c !== " ");
const max = Math.max(1, lettersOnly.length - 1);
let li = 0;
---

<section class={styles.app} data-bbq-calculator data-state="idle">
  <h1 class={styles.title} aria-label={titleText}>
    {titleChars.map((ch, i) =>
      ch === " " ? (
        <span class={styles.space}>&nbsp;</span>
      ) : (
        <span class={styles.letter} style={`--i:${i};--p:${/* seu --p atual */ ""}`}>{ch}</span>
      )
    )}
  </h1>

  <!-- overlay loader e resto do conte√∫do continuam aqui -->

  <!-- Overlay do loader (central) -->
  <div class={styles.loaderOverlay} data-loader-overlay hidden>
    <div class={styles.loaderCard}>
      <div class={styles.emojiRow} data-emoji-row aria-hidden="true"></div>

      <div class={styles.progressWrap}>
        <div class={styles.bigEmoji} data-big-emoji>üî•</div>

        <div class={styles.progressBar}>
          <div class={styles.progressFill} data-progress-fill></div>
        </div>

        <div class={styles.progressPct} data-progress-pct>0%</div>
      </div>

      <div class={styles.loaderHint}>Assando o c√°lculo‚Ä¶</div>
    </div>
  </div>

  <!-- Conte√∫do principal -->
  <div class={styles.appGrid} data-app-grid>
    <!-- ESQUERDA -->
    <div class={styles.left}>
      <div class={styles.card}>
        <div class={styles.grid}>
          <label class={styles.label}>
            Adultos
            <input class={styles.input} data-adults type="number" min="0" value="6" />
          </label>

          <label class={styles.label}>
            Crian√ßas
            <input class={styles.input} data-kids type="number" min="0" value="2" />
          </label>

          <label class={styles.label}>
            Dura√ß√£o
            <select class={styles.input} data-hours>
              {DURATION_RULES.map((r) => (
                <option value={r.id}>{r.label}</option>
              ))}
            </select>
          </label>
        </div>

        <div class={styles.meats}>
          <div class={styles.meatsHeader}>
            <strong>Escolha as carnes</strong>
            <span class={styles.meatsHint} data-hint>O ‚Äúpeso‚Äù aparece depois do c√°lculo üòâ</span>
          </div>

          <div class={styles.meatGrid}>
            {meats.map((m) => (
              <div class={styles.meatRow}>
                <label class={styles.toggle}>
                  <input type="checkbox" data-meat-check value={m.id} checked />
                  {m.label}
                </label>

                <label class={styles.meatWeightLabel}>
                  Peso
                  <input
                    class={`${styles.input} ${styles.inputSmall}`}
                    data-meat-weight
                    data-meat-id={m.id}
                    type="number"
                    min="0"
                    step="1"
                    value={m.defaultWeight}
                  />
                </label>
              </div>
            ))}
          </div>
        </div>

        <div class={styles.actions}>
          <button class={styles.calcBtn} type="button" data-calc-btn>
            Calcular! ü•©
          </button>
        </div>
      </div>
    </div>

    <!-- DIREITA (s√≥ aparece no DONE) -->
    <div class={styles.right}>
      <div class={styles.card} data-advanced hidden>
        <strong>Ajustes r√°pidos</strong>

        <div class={styles.advancedGrid}>
          <label class={styles.label}>
            Margem de sobra
            <select class={styles.input} data-waste>
              <option value="0">0%</option>
              <option value={DEFAULTS.wastePct} selected>10%</option>
              <option value="0.2">20%</option>
            </select>
          </label>

          <label class={styles.label}>
            Cerveja (por adulto)
            <select class={styles.input} data-beer-profile>
              <option value="none">Sem √°lcool</option>
              <option value="light">Leve</option>
              <option value="medium" selected>M√©dio</option>
              <option value="heavy">Alto</option>
            </select>
          </label>

          <label class={styles.toggleInline}>
            <input data-include-soda type="checkbox" checked />
            Incluir refri/√°gua
          </label>
        </div>
      </div>

      <div class={`${styles.card} ${styles.results}`} data-results-box hidden>
        <strong>Resultado</strong>

        <div class={styles.row}><span>Carne (total)</span><span data-meat-out>-</span></div>
        <div class={styles.breakdown} data-meat-breakdown></div>

        <hr class={styles.hr} />

        <div class={styles.row}><span>P√£o de alho</span><span data-bread-out>-</span></div>
        <div class={styles.row}><span>Carv√£o</span><span data-coal-out>-</span></div>
        <div class={styles.row}><span>Sal grosso</span><span data-salt-out>-</span></div>

        <hr class={styles.hr} />

        <div class={styles.row}><span>Cerveja</span><span data-beer-out>-</span></div>
        <div class={styles.row}><span>Refri/√Ågua</span><span data-soda-out>-</span></div>
      </div>
    </div>
  </div>

<script>
  import initBbqCalculator from "../scripts/barbecueCalculator.js";
  const boot = () => initBbqCalculator();
  document.addEventListener("astro:page-load", boot);
  boot();
</script>

</section>
