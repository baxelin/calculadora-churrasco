---
import styles from "../styles/calculator.module.css";
import { DURATION_RULES, MEATS, DEFAULTS } from "../config/bbqConfig.js";

type Meat = { id: string; label: string; defaultWeight: number; group?: string };
const meats = MEATS as unknown as Meat[];

const totalW = meats.reduce((acc, m) => acc + (m.defaultWeight ?? 1), 0) || 1;

// shares iniciais (inteiros) somando 100
const defaultShares: Record<string, number> = {};
let running = 0;
meats.forEach((m, idx) => {
  const raw = Math.round(((m.defaultWeight ?? 1) / totalW) * 100);
  defaultShares[m.id] = raw;
  running += raw;
});
// ajusta a √∫ltima pra fechar 100
if (meats.length) {
  const last = meats[meats.length - 1].id;
  defaultShares[last] += (100 - running);
}


const titleText = "Calculadora de Churrasco 2000";
const titleChars = [...titleText];
const lettersOnly = titleChars.filter((c) => c !== " ");
const max = Math.max(1, lettersOnly.length - 1);
let li = 0;
---

<section class={styles.app} data-bbq-calculator data-state="idle">
  <h1 class={styles.title} aria-label={titleText}>
    {titleChars.map((ch, i) =>
      ch === " " ? (
        <span class={styles.space}>&nbsp;</span>
      ) : (
        <span class={styles.letter} style={`--i:${i};--p:${/* seu --p atual */ ""}`}>{ch}</span>
      )
    )}
  </h1>

  <!-- overlay loader e resto do conte√∫do continuam aqui -->

  <!-- Overlay do loader (central) -->
  <div class={styles.loaderOverlay} data-loader-overlay hidden>
    <div class={styles.loaderCard}>
      <div class={styles.emojiRow} data-emoji-row aria-hidden="true"></div>

      <div class={styles.progressWrap}>
        <div class={styles.bigEmoji} data-big-emoji>üî•</div>

        <div class={styles.progressBar}>
          <div class={styles.progressFill} data-progress-fill></div>
        </div>

        <div class={styles.progressPct} data-progress-pct>0%</div>
      </div>

      <div class={styles.loaderHint}>Assando o c√°lculo‚Ä¶</div>
    </div>
  </div>

  <!-- Conte√∫do principal -->
  <div class={styles.appGrid} data-app-grid>
    <!-- ESQUERDA -->
    <div class={styles.left}>
      <div class={styles.card}>
        <div class={styles.grid}>
          <label class={styles.label}>
            Adultos
            <input class={styles.input} data-adults type="number" min="0" value="6" />
          </label>

          <label class={styles.label}>
            Crian√ßas
            <input class={styles.input} data-kids type="number" min="0" value="2" />
          </label>

          <label class={styles.label}>
            Dura√ß√£o
            <select class={styles.input} data-hours>
              {DURATION_RULES.map((r) => (
                <option value={r.id}>{r.label}</option>
              ))}
            </select>
          </label>
        </div>

        <div class={styles.meats}>
          <div class={styles.meatsHeader}>
            <strong>Escolha as carnes</strong>
            <span class={styles.meatsHint} data-hint>O ‚Äúpeso‚Äù aparece depois do c√°lculo üòâ</span>
          </div>

          <div class={styles.meatGrid}>
            {meats.map((m) => (
              <div class={styles.meatRow} data-meat-row data-meat-id={m.id}>
                <label class={styles.toggle}>
                  <input type="checkbox" data-meat-check value={m.id} checked />
                  {m.label}
                </label>
                <label class={styles.meatWeightLabel}>
                  Prefer√™ncia
                  <div class={styles.shareCtrl}>
                    <input
                      class={styles.range}
                      type="range"
                      min="0"
                      max="100"
                      step="1"
                      value={defaultShares[m.id] ?? 0}
                      data-meat-share
                      data-meat-id={m.id}
                      aria-label={`Prefer√™ncia ${m.label}`}
                    />
                    <span class={styles.sharePct} data-meat-share-value data-meat-id={m.id}>
                      {(defaultShares[m.id] ?? 0)}%
                    </span>
                  </div>
                    <label class={styles.lockToggle}>
                      <input type="checkbox" data-meat-lock data-meat-id={m.id} />
                      üîí Travar
                    </label>
                </label>

              </div>
            ))}
          </div>
        </div>

        <div class={styles.actions}>
          <button class={styles.calcBtn} type="button" data-calc-btn>
            Calcular! ü•©
          </button>
        </div>
      </div>
    </div>

    <!-- DIREITA (s√≥ aparece no DONE) -->
    <div class={styles.right}>
      <div class={styles.card} data-advanced hidden>
        <strong>Ajustes r√°pidos</strong>

        <div class={styles.advancedGrid}>
          <label class={styles.label}>
            Margem de sobra
            <select class={styles.input} data-waste>
              <option value="0">0%</option>
              <option value={DEFAULTS.wastePct} selected>10%</option>
              <option value="0.2">20%</option>
            </select>
          </label>

          <label class={styles.label}>
            Cerveja (por adulto)
            <select class={styles.input} data-beer-profile>
              <option value="none">Sem √°lcool</option>
              <option value="light">Leve</option>
              <option value="medium" selected>M√©dio</option>
              <option value="heavy">Alto</option>
            </select>
          </label>

          <label class={styles.toggleInline}>
            <input data-include-soda type="checkbox" checked />
            Incluir refri/√°gua
          </label>
        </div>
      </div>

      <div class={`${styles.card} ${styles.results}`} data-results-box hidden>
        <strong>Resultado</strong>

        <div class={styles.row}><span>Carne (total)</span><span data-meat-out>-</span></div>
        <div class={styles.breakdown} data-meat-breakdown></div>

        <hr class={styles.hr} />

        <div class={styles.row}><span>P√£o de alho</span><span data-bread-out>-</span></div>
        <div class={styles.row}><span>Carv√£o</span><span data-coal-out>-</span></div>
        <div class={styles.row}><span>Sal grosso</span><span data-salt-out>-</span></div>

        <hr class={styles.hr} />

        <div class={styles.row}><span>Cerveja</span><span data-beer-out>-</span></div>
        <div class={styles.row}><span>Refri/√Ågua</span><span data-soda-out>-</span></div>

        <hr class={styles.hr} />

        <div class={styles.shareBar}>
          <button type="button" class={styles.shareBtn} data-copy-btn>Copiar lista üìã</button>
          <button type="button" class={`${styles.shareBtn} ${styles.shareBtnHot}`} data-wa-btn>
            <span class={styles.waIcon} aria-hidden="true">
              <svg viewBox="0 0 32 32" width="18" height="18">
                <path fill="currentColor" d="M19.11 17.51c-.28-.14-1.64-.81-1.9-.9-.26-.1-.45-.14-.64.14-.19.28-.73.9-.9 1.09-.17.19-.33.21-.61.07-.28-.14-1.2-.44-2.28-1.4-.84-.75-1.4-1.68-1.56-1.96-.16-.28-.02-.43.12-.57.12-.12.28-.33.42-.5.14-.17.19-.28.28-.47.1-.19.05-.36-.02-.5-.07-.14-.64-1.54-.88-2.12-.23-.55-.46-.48-.64-.49h-.55c-.19 0-.5.07-.76.36-.26.28-1 1-.99 2.43 0 1.43 1.03 2.81 1.18 3 .14.19 2.03 3.1 4.92 4.35.69.3 1.23.48 1.65.61.69.22 1.32.19 1.82.12.55-.08 1.64-.67 1.87-1.31.23-.64.23-1.19.16-1.31-.07-.12-.26-.19-.55-.33zM16.02 27c-1.97 0-3.9-.52-5.6-1.52L6 27l1.54-4.23A10.9 10.9 0 0 1 5.1 16.1C5.1 10.03 10.01 5.1 16.08 5.1c2.94 0 5.7 1.15 7.78 3.23a10.93 10.93 0 0 1 3.2 7.77c0 6.07-4.93 10.9-11.04 10.9zM16.08 3C8.84 3 3 8.84 3 16.1c0 2.18.54 4.31 1.57 6.2L3 29l6.88-1.8a13.1 13.1 0 0 0 6.14 1.54C23.28 28.74 29 23.06 29 16.1 29 8.84 23.28 3 16.08 3z"/>
              </svg>
            </span>
            Mandar no WhatsApp
          </button>

          <span class={styles.toast} data-toast hidden>Copiado!</span>
        </div>

        <div class={styles.disclaimer}>
          Estimativa marota. Ajuste conforme a fome do pessoal üòã
        </div>
      </div>
    </div>
  </div>

<script>
  import initBbqCalculator from "../scripts/barbecueCalculator.js";
  const boot = () => initBbqCalculator();
  document.addEventListener("astro:page-load", boot);
  boot();
</script>

</section>
